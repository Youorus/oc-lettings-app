name: Main Pipeline (tests ‚Üí build ‚Üí release ‚Üí docker)

on:
  push:
    branches: [ main ]      # üîî se d√©clenche √† chaque push sur main
  workflow_dispatch: {}     # run manuel possible

permissions:
  contents: write

jobs:
  gate:
    name: Gate (run only if HEAD contains origin/develop)
    runs-on: ubuntu-latest
    outputs:
      run: ${{ steps.chk.outputs.run }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Fetch develop
        run: git fetch origin develop:origin/develop
      - name: Check ancestry (HEAD includes develop?)
        id: chk
        shell: bash
        run: |
          if git merge-base --is-ancestor origin/develop HEAD; then
            echo "run=yes" >> "$GITHUB_OUTPUT"
            echo "HEAD includes origin/develop ‚Üí OK"
          else
            echo "run=no" >> "$GITHUB_OUTPUT"
            echo "HEAD does NOT include origin/develop ‚Üí skip"
          fi

  tests:
    name: ‚úÖ Tests (Django + pytest)
    needs: gate
    if: needs.gate.outputs.run == 'yes'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Pas de collectstatic ici : on utilise le mode tests (DJANGO_TESTS=1) dans settings.py
      - name: Django checks & tests
        env:
          DJANGO_SETTINGS_MODULE: oc_lettings_site.settings
          DJANGO_TESTS: "1"
        run: |
          python manage.py check
          pytest -q --maxfail=1 --disable-warnings

  build:
    name: üß± Build Docker (validation, cache ON)
    needs: tests
    if: needs.tests.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: docker/setup-buildx-action@v3

      - name: Docker build (no push, cache GHA + registry)
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64            # ‚ö° plus rapide; remettre arm64 si n√©cessaire
          push: false
          load: false
          tags: ci-validation:latest
          cache-from: |
            type=gha
            type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/oc-lettings-site:latest
          cache-to: type=gha,mode=max
          provenance: false
          sbom: false
          build-args: |
            BUILDKIT_INLINE_CACHE=1

  release:
    name: üè∑Ô∏è Create Tag + GitHub Release
    needs: build
    if: needs.build.result == 'success'
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.ver.outputs.next }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute next version
        id: ver
        shell: bash
        run: |
          last_tag=$(git describe --tags --abbrev=0 --match 'v*' 2>/dev/null || echo "")
          if [[ -z "$last_tag" ]]; then
            major=1; minor=0
          else
            ver="${last_tag#v}"
            IFS='.' read -r major minor patch <<< "${ver}.0.0"
            minor=$((minor + 1))
            if [[ $minor -gt 10 ]]; then
              major=$((major + 1)); minor=0
            fi
          fi
          next="v${major}.${minor}"
          echo "next=${next}" >> "$GITHUB_OUTPUT"
          echo "Next version: ${next}"

      - name: Create git tag
        env:
          TAG: ${{ steps.ver.outputs.next }}
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.next }}
          name: ${{ steps.ver.outputs.next }}
          generate_release_notes: true

  docker:
    name: üê≥ Build & Push Docker (cache GHA + inline)
    needs: release
    if: needs.release.result == 'success' && needs.gate.outputs.run == 'yes'
    runs-on: ubuntu-latest
    env:
      TAG: ${{ needs.release.outputs.tag }}
      DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_IMAGE: oc-lettings-site
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push (cache GHA + registry inline)
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64            # ‚ö° plus rapide; remettre arm64 si n√©cessaire
          push: true
          cache-from: |
            type=gha
            type=registry,ref=${{ env.DOCKERHUB_USER }}/${{ env.DOCKERHUB_IMAGE }}:latest
          cache-to: |
            type=gha,mode=max
            type=inline
          tags: |
            ${{ env.DOCKERHUB_USER }}/${{ env.DOCKERHUB_IMAGE }}:${{ env.TAG }}
            ${{ env.DOCKERHUB_USER }}/${{ env.DOCKERHUB_IMAGE }}:latest
          provenance: false
          sbom: false
          build-args: |
            BUILDKIT_INLINE_CACHE=1